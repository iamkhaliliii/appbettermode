# Server Directory Structure

این دایرکتوری شامل فایل‌های TypeScript اصلی برای سرور برنامه است که پس از کامپایل، به عنوان توابع serverless در Vercel استفاده می‌شوند.

## ساختار دایرکتوری

- `/routes/` - تعریف مسیرهای API
  - `index.ts` - روتر اصلی
  - `sites.ts` - نقاط پایانی مربوط به سایت‌ها
  - `posts.ts` - مدیریت محتوا و پست‌ها
  - `cms-types.ts` - انواع سیستم مدیریت محتوا
  - `spaces.ts` - مدیریت فضاهای سایت
  - `users.ts` - مدیریت کاربران
  
- `/db/` - اتصال به پایگاه داده و مدل‌ها
  - `index.ts` - تنظیمات اتصال به پایگاه داده
  - `schema.ts` - تعریف ساختار پایگاه داده با Drizzle ORM
  
- `/utils/` - توابع کمکی
  - `logger.ts` - ابزارهای لاگ‌گیری
  - `environment.ts` - تشخیص محیط اجرا و متغیرهای محیطی
  - `errors.ts` - مدیریت خطاها
  - `api-helpers.ts` - توابع کمکی API
  - `brandfetch.ts` - یکپارچگی با Brandfetch API
  - `vercel.ts` - تنظیمات Vercel

- `index.ts` - نقطه ورودی اصلی سرور
- `env.ts` - بارگذاری متغیرهای محیطی
- `tsconfig.server.json` - تنظیمات TypeScript برای سرور

## فرآیند توسعه و ساخت

کد TypeScript در این دایرکتوری نوشته می‌شود و سپس به JavaScript در پوشه `/api` کامپایل می‌شود:

1. توسعه در محیط محلی با اجرای `npm run dev`
2. کامپایل به JavaScript با اجرای `npm run build`
3. فایل‌های کامپایل شده در پوشه `/api` برای استقرار در Vercel استفاده می‌شوند

## نکات مهم

- تمام تغییرات باید در این دایرکتوری انجام شود، نه در دایرکتوری `/api`
- از اسکریپت `scripts/build.mjs` برای همگام‌سازی بین `/server` و `/api` استفاده می‌شود
- ساختار کد به گونه‌ای طراحی شده که هم در محیط محلی و هم در محیط Vercel کار کند
- API keys و اطلاعات حساس باید در متغیرهای محیطی قرار گیرند، نه در کد

## متغیرهای محیطی

برنامه به متغیرهای محیطی زیر نیاز دارد:

- `NODE_ENV` - تنظیم به `development` یا `production`
- `DATABASE_URL` - رشته اتصال PostgreSQL
- `PORT` - پورت سرور (پیش‌فرض: 4000)
- `VERCEL` - تنظیم به `1` در محیط Vercel
- `BRANDFETCH_API_KEY` - کلید API برای Brandfetch