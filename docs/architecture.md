# معماری برنامه

این سند، معماری کلی برنامه را توضیح می‌دهد و نحوه همکاری اجزای مختلف را شرح می‌دهد.

## ساختار کلی پروژه

پروژه از سه بخش اصلی تشکیل شده است:

1. **فرانت‌اند (client)** - برنامه React که با استفاده از Vite ساخته شده
2. **بک‌اند (server)** - فایل‌های TypeScript برای API
3. **API مستقر روی Vercel (api)** - فایل‌های JavaScript کامپایل شده برای استقرار روی Vercel

## مسیر داده

```
Client (React) <--> API (Express/Vercel) <--> Database (PostgreSQL)
```

## جریان کار توسعه

1. تغییرات در فایل‌های TypeScript در پوشه `server` انجام می‌شود
2. با اجرای `npm run dev` یک سرور توسعه محلی راه‌اندازی می‌شود
3. با اجرای `npm run build` فایل‌های TypeScript به JavaScript کامپایل می‌شوند
4. فایل‌های کامپایل شده در پوشه `api` برای استقرار در Vercel استفاده می‌شوند

## معماری یکپارچه API

معماری یکپارچه API به گونه‌ای طراحی شده که همزمان در دو محیط کار کند:

1. **محیط توسعه محلی**: از Express.js برای ارائه API استفاده می‌کند
2. **محیط Vercel**: از توابع Serverless برای ارائه API استفاده می‌کند

کلید این معماری در فایل‌های زیر است:

- `server/utils/environment.ts`: تشخیص محیط اجرا
- `server/utils/errors.ts`: استاندارد‌سازی پاسخ‌های خطا
- `client/src/lib/api.ts`: تطبیق‌دهنده API در سمت کلاینت

## بانک اطلاعاتی

این پروژه از PostgreSQL به عنوان پایگاه داده استفاده می‌کند و با کتابخانه‌های زیر کار می‌کند:

- **Drizzle ORM**: برای تعامل با پایگاه داده
- **Zod**: برای اعتبارسنجی داده‌ها

مدل‌های بانک اطلاعاتی در `server/db/schema.ts` تعریف شده‌اند.

## مسیرهای API

### API سایت‌ها:

- `GET /api/v1/sites`: دریافت لیست تمام سایت‌ها
- `POST /api/v1/sites`: ایجاد یک سایت جدید
- `GET /api/v1/sites/:id`: دریافت اطلاعات یک سایت خاص با شناسه یا زیردامنه

### API سلامت:

- `GET /api/health`: بررسی وضعیت سلامت API

## مدیریت خطا

خطاها به صورت استاندارد و با ساختار زیر برگردانده می‌شوند:

```json
{
  "message": "پیام خطا",
  "errors": {
    "fieldErrors": {
      "فیلد۱": ["خطای مربوط به فیلد۱"],
      "فیلد۲": ["خطای مربوط به فیلد۲"]
    }
  }
}
```

## امنیت

هدرهای CORS به صورت خودکار برای همه API ها تنظیم می‌شوند. احراز هویت کاربران در نسخه بعدی پیاده‌سازی خواهد شد. 